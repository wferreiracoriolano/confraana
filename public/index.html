<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Roleta da ConfraternizaÃ§Ã£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }

    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #02010f 100%);
      color:#f9fafb;
      padding:16px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .app{
      width:100%;
      max-width:1100px;
      background: radial-gradient(circle at top left, #020617, #020617 30%, #020617 100%);
      border-radius:32px;
      padding:28px;
      box-shadow: 0 25px 60px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at -10% 0, rgba(251,191,36,.08), transparent 55%),
        radial-gradient(circle at 110% 20%, rgba(56,189,248,.07), transparent 55%);
      pointer-events:none;
    }

    header{
      position:relative;
      z-index:1;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:24px;
    }
    .titleWrap h1{ margin:0; font-size:1.8rem; letter-spacing:.02em; }
    .titleWrap span{ display:block; margin-top:6px; font-size:.95rem; opacity:.85; }

    button,input{ font-size:1rem; }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 18px;
      cursor:pointer;
      background: linear-gradient(135deg, #facc15, #f97316);
      color:#111827;
      font-weight:700;
      transition:transform .1s, box-shadow .1s, filter .1s;
      white-space:nowrap;
    }
    .btn:hover{ filter:brightness(1.05); box-shadow:0 10px 25px rgba(250,204,21,.35); transform:translateY(-1px); }
    .btn:active{ transform:translateY(1px); box-shadow:none; }

    .btn-outline{
      background:transparent;
      color:#e5e7eb;
      border-radius:999px;
      padding:9px 16px;
      border:1px solid rgba(148,163,184,.7);
      font-weight:600;
    }
    .btn-outline:hover{ background:rgba(15,23,42,.65); box-shadow:0 10px 25px rgba(15,23,42,.6); }

    .main{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap:24px;
      align-items:start;
    }

    .card{
      background: radial-gradient(circle at top left, rgba(15,23,42,.95), rgba(15,23,42,.97));
      border-radius:24px;
      padding:20px 22px;
      border:1px solid rgba(30,64,175,.5);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.8), 0 18px 45px rgba(15,23,42,.9);
    }
    .card h2{ margin:0 0 10px; font-size:1.25rem; }
    .card p{ margin:0 0 10px; font-size:.92rem; color:#d1d5db; }

    .field-group{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .field-group input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:10px 14px;
      background: radial-gradient(circle at top, rgba(15,23,42,.96), rgba(15,23,42,1));
      color:#f9fafb;
      outline:none;
      min-width:0;
    }
    .field-group input::placeholder{ color:#6b7280; }
    .field-group input:focus{ border-color:#facc15; box-shadow:0 0 0 1px #facc15; }

    .status{ margin-top:8px; font-size:.92rem; color:#9ca3af; }
    .status.error{ color:#fca5a5; }

    .roulette{
      margin-top:18px;
      height:130px;
      border-radius:18px;
      border:1px dashed rgba(156,163,175,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background: radial-gradient(circle at center, rgba(30,64,175,.25), rgba(15,23,42,1));
    }
    .roulette.spin{ animation: spinBorder .8s ease-in-out 2; }
    @keyframes spinBorder{ 0%{transform:rotate(0)} 25%{transform:rotate(1.5deg)} 50%{transform:rotate(-1.5deg)} 100%{transform:rotate(0)} }
    .roulette-inner{ text-align:center; max-width:90%; }
    .result-label{ font-size:.8rem; text-transform:uppercase; letter-spacing:.12em; color:#9ca3af; margin-bottom:6px; }
    .result-item{ font-size:1.45rem; font-weight:900; color:#fbbf24; }

    .badge-admin{
      display:inline-block;
      font-size:.75rem;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.2);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,.7);
      margin-left:8px;
      vertical-align:middle;
    }

    .draws-list, .items-list{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,.85);
      padding:6px;
      background: radial-gradient(circle at top, rgba(15,23,42,.97), rgba(15,23,42,1));
      max-height:320px;
      overflow:auto;
    }
    .draw-row, .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
    }
    .draw-row:nth-child(odd), .item-row:nth-child(odd){ background:rgba(17,24,39,.9); }
    .draw-row:nth-child(even), .item-row:nth-child(even){ background:rgba(15,23,42,.95); }

    .draw-row-main{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .draw-row-main strong{ font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .draw-row-main small{ font-size:.75rem; color:#9ca3af; }

    .pill{
      flex-shrink:0;
      font-size:.75rem;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(120,53,15,.4);
      color:#fed7aa;
      border:1px solid rgba(248,153,64,.8);
      white-space:nowrap;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:18px;
    }
    .modal{
      width:100%;
      max-width:360px;
      background:#020617;
      border-radius:16px;
      padding:18px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 20px 40px rgba(0,0,0,.6);
    }
    .modal h2{ margin:0 0 12px; font-size:1.1rem; }
    .modal .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .modal label{ font-size:.8rem; color:#9ca3af; }
    .modal input{
      border-radius:999px;
      border:1px solid rgba(75,85,99,.8);
      padding:10px 12px;
      background:rgba(15,23,42,.9);
      color:#f9fafb;
      outline:none;
    }
    .modal-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }

    /* âœ… MOBILE: ocupa tela toda, alinhado, empilha e melhora o header */
    @media (max-width: 900px){
      body{
        padding:0;
        display:block;           /* remove centralizaÃ§Ã£o do flex */
      }
      .app{
        max-width:none;
        width:100%;
        border-radius:0;
        padding:16px;
        min-height:100vh;
      }
      header{
        flex-direction:row;
        align-items:flex-start;
        gap:10px;
        margin-bottom:16px;
      }
      .titleWrap h1{ font-size:1.35rem; }
      .titleWrap span{ font-size:.9rem; }
      .main{
        grid-template-columns: 1fr; /* empilha */
        gap:16px;
      }
      .card{ padding:16px; border-radius:20px; }
      .field-group{ flex-direction:column; align-items:stretch; }
      .field-group .btn{ width:100%; }
      .draws-list, .items-list{ max-height:260px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="titleWrap">
        <h1>Roleta da ConfraternizaÃ§Ã£o</h1>
        <span>Digite seu nome, gire a roleta e descubra o que levar ðŸŽ‰</span>
      </div>

      <button id="btnLogin" class="btn-outline">Login admin</button>
    </header>

    <div class="main">
      <!-- ESQUERDA: ROLETa -->
      <div class="card">
        <h2>Participar</h2>
        <p>Digite seu nome e clique em <strong>Girar roleta</strong>.</p>

        <div class="field-group">
          <input id="nomeInput" type="text" placeholder="Seu nome completo" />
          <button id="btnSortear" class="btn">Girar roleta</button>
        </div>

        <div id="statusUser" class="status"></div>

        <div id="rouletteBox" class="roulette">
          <div class="roulette-inner">
            <div class="result-label">VOCÃŠ VAI LEVAR</div>
            <div id="resultText" class="result-item">â€” aguardando sorteio â€”</div>
          </div>
        </div>
      </div>

      <!-- DIREITA: LISTA PÃšBLICA + ADMIN -->
      <div class="card">
        <h2>
          Lista da confraternizaÃ§Ã£o
          <span id="badgeAdmin" class="badge-admin" style="display:none;">Admin ativo</span>
        </h2>
        <p>Todos conseguem ver quem estÃ¡ levando o quÃª.</p>

        <h3 style="margin:10px 0 6px;">Quem jÃ¡ estÃ¡ levando o quÃª</h3>
        <div id="publicDrawsList" class="draws-list"></div>

        <!-- SOMENTE ADMIN -->
        <div id="adminContent" style="display:none; margin-top:14px;">
          <h3 style="margin:10px 0 6px;">OpÃ§Ãµes da roleta (somente admin)</h3>

          <div class="field-group">
            <input id="itemInput" type="text" placeholder="Ex: Carne, Refrigerante, Sobremesa..." />
            <button id="btnAddItem" class="btn">Adicionar</button>
          </div>

          <div id="statusAdmin" class="status"></div>
          <div id="itemsList" class="items-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL LOGIN -->
  <div id="loginModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h2>Login administrador</h2>

      <div class="field">
        <label>UsuÃ¡rio</label>
        <input id="userField" type="text" placeholder="admin" />
      </div>

      <div class="field">
        <label>Senha</label>
        <input id="passField" type="password" placeholder="admin" />
      </div>

      <div id="loginError" class="status error"></div>

      <div class="modal-actions">
        <button id="btnCancelLogin" class="btn-outline">Cancelar</button>
        <button id="btnDoLogin" class="btn">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "";
    const TOKEN_KEY = "confraternizacao_admin_token";

    const nomeInput = document.getElementById("nomeInput");
    const btnSortear = document.getElementById("btnSortear");
    const resultText = document.getElementById("resultText");
    const rouletteBox = document.getElementById("rouletteBox");
    const statusUser = document.getElementById("statusUser");

    const btnLogin = document.getElementById("btnLogin");
    const loginModal = document.getElementById("loginModal");
    const btnCancelLogin = document.getElementById("btnCancelLogin");
    const btnDoLogin = document.getElementById("btnDoLogin");
    const userField = document.getElementById("userField");
    const passField = document.getElementById("passField");
    const loginError = document.getElementById("loginError");

    const badgeAdmin = document.getElementById("badgeAdmin");
    const adminContent = document.getElementById("adminContent");
    const itemInput = document.getElementById("itemInput");
    const btnAddItem = document.getElementById("btnAddItem");
    const itemsList = document.getElementById("itemsList");
    const statusAdmin = document.getElementById("statusAdmin");

    const publicDrawsList = document.getElementById("publicDrawsList");

    let adminToken = null;

    function setAdminUI(enabled){
      if(enabled){
        adminContent.style.display = "block";
        badgeAdmin.style.display = "inline-block";
        btnLogin.textContent = "Sair";
      }else{
        adminContent.style.display = "none";
        badgeAdmin.style.display = "none";
        btnLogin.textContent = "Login admin";
      }
    }

    function showLoginModal(show){
      loginModal.style.display = show ? "flex" : "none";
      if(show){
        loginError.textContent = "";
        userField.value = "admin";
        passField.value = "";
        userField.focus();
      }
    }

    function logoutAdmin(){
      adminToken = null;
      localStorage.removeItem(TOKEN_KEY);
      setAdminUI(false);
    }

    async function validateAdminToken(){
      // âœ… evita â€œadmin presoâ€ no celular por cache/localStorage
      if(!adminToken) return;
      try{
        // chamamos uma rota admin com payload invÃ¡lido; se token for vÃ¡lido, retorna 400 (nÃ£o 401)
        const res = await fetch(API_BASE + "/api/items", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + adminToken
          },
          body: JSON.stringify({ name: "" })
        });
        if(res.status === 401){
          logoutAdmin();
        }
      }catch(e){
        // se cair conexÃ£o, nÃ£o altera nada
      }
    }

    function loadTokenFromStorage(){
      const t = localStorage.getItem(TOKEN_KEY);
      if(t){
        adminToken = t;
        setAdminUI(true);
      }else{
        setAdminUI(false);
      }
    }

    async function loginAdmin(){
      loginError.textContent = "";
      const username = userField.value.trim();
      const password = passField.value.trim();
      if(!username || !password){
        loginError.textContent = "Preencha usuÃ¡rio e senha.";
        return;
      }
      try{
        const res = await fetch(API_BASE + "/api/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          loginError.textContent = data.error || "Falha no login.";
          return;
        }
        adminToken = data.token;
        localStorage.setItem(TOKEN_KEY, adminToken);
        setAdminUI(true);
        showLoginModal(false);
        fetchItems();
      }catch(e){
        loginError.textContent = "Erro ao tentar logar.";
      }
    }

    async function fetchPublicDraws(){
      try{
        const res = await fetch(API_BASE + "/api/draws");
        const data = await res.json();
        renderPublicDraws(data);
      }catch(e){
        publicDrawsList.innerHTML = "<div class='status error'>Erro ao carregar lista.</div>";
      }
    }

    function renderPublicDraws(draws){
      if(!draws || draws.length === 0){
        publicDrawsList.innerHTML = "<div class='status'>NinguÃ©m participou ainda.</div>";
        return;
      }
      publicDrawsList.innerHTML = "";
      draws.forEach(d=>{
        const row = document.createElement("div");
        row.className = "draw-row";

        const main = document.createElement("div");
        main.className = "draw-row-main";

        const strong = document.createElement("strong");
        strong.textContent = d.person_name;

        const small = document.createElement("small");
        small.textContent = new Date(d.created_at).toLocaleString("pt-BR");

        main.appendChild(strong);
        main.appendChild(small);

        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = d.item_name;

        row.appendChild(main);
        row.appendChild(pill);

        publicDrawsList.appendChild(row);
      });
    }

    async function sortear(){
      statusUser.textContent = "";
      statusUser.classList.remove("error");

      const nome = nomeInput.value.trim();
      if(!nome){
        statusUser.textContent = "Digite seu nome antes de girar a roleta.";
        return;
      }

      rouletteBox.classList.add("spin");
      resultText.textContent = "Girando...";

      try{
        const res = await fetch(API_BASE + "/api/draw", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name: nome })
        });
        const data = await res.json().catch(()=>({}));

        setTimeout(()=>{
          rouletteBox.classList.remove("spin");
          if(!res.ok){
            statusUser.textContent = data.error || "Erro ao sortear.";
            statusUser.classList.add("error");
            resultText.textContent = "â€” erro â€”";
            return;
          }
          resultText.textContent = data.item || "â€”";
          statusUser.textContent = data.alreadyAssigned
            ? "VocÃª jÃ¡ tinha participado. Mostrando o mesmo item ðŸ˜‰"
            : "Item sorteado! Seu nome jÃ¡ apareceu na lista ðŸ‘‰";
          fetchPublicDraws();
        }, 700);
      }catch(e){
        rouletteBox.classList.remove("spin");
        statusUser.textContent = "Erro de conexÃ£o ao sortear.";
        statusUser.classList.add("error");
        resultText.textContent = "â€” erro â€”";
      }
    }

    async function fetchItems(){
      if(!adminToken) return;
      try{
        const res = await fetch(API_BASE + "/api/items");
        const data = await res.json();
        renderItemsAdmin(data);
      }catch(e){
        // silencioso
      }
    }

    function renderItemsAdmin(items){
      if(!items || items.length === 0){
        itemsList.innerHTML = "<div class='status'>Nenhuma opÃ§Ã£o cadastrada ainda.</div>";
        return;
      }
      itemsList.innerHTML = "";
      items.forEach(item=>{
        const row = document.createElement("div");
        row.className = "item-row";

        const span = document.createElement("span");
        span.textContent = item.name;

        const del = document.createElement("button");
        del.className = "btn-outline";
        del.style.fontSize = "0.8rem";
        del.textContent = "Remover";
        del.onclick = ()=>deleteItem(item.id);

        row.appendChild(span);
        row.appendChild(del);
        itemsList.appendChild(row);
      });
    }

    async function addItem(){
      statusAdmin.textContent = "";
      const name = itemInput.value.trim();
      if(!name){
        statusAdmin.textContent = "Digite o nome do item.";
        return;
      }
      try{
        const res = await fetch(API_BASE + "/api/items", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + adminToken
          },
          body: JSON.stringify({ name })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          statusAdmin.textContent = data.error || "Erro ao criar item.";
          return;
        }
        itemInput.value = "";
        statusAdmin.textContent = "Item adicionado!";
        fetchItems();
      }catch(e){
        statusAdmin.textContent = "Erro ao criar item.";
      }
    }

    async function deleteItem(id){
      if(!confirm("Remover este item?")) return;
      try{
        const res = await fetch(API_BASE + "/api/items/" + id, {
          method:"DELETE",
          headers:{ "Authorization":"Bearer " + adminToken }
        });
        if(!res.ok) return;
        fetchItems();
      }catch(e){
        // silencioso
      }
    }

    // eventos
    btnSortear.addEventListener("click", sortear);
    nomeInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sortear(); });

    btnLogin.addEventListener("click", ()=>{
      if(adminToken){
        if(confirm("Deseja sair do modo admin?")) logoutAdmin();
      }else{
        showLoginModal(true);
      }
    });

    btnCancelLogin.addEventListener("click", ()=>showLoginModal(false));
    btnDoLogin.addEventListener("click", loginAdmin);
    passField.addEventListener("keydown",(e)=>{ if(e.key==="Enter") loginAdmin(); });

    btnAddItem.addEventListener("click", addItem);
    itemInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") addItem(); });

    // init
    loadTokenFromStorage();
    validateAdminToken();
    fetchPublicDraws();
    if(adminToken) fetchItems();
  </script>
</body>
</html>
